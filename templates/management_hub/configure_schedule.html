{% extends "base.html" %}

{% block extra_css %}
<!-- Your custom CSS here if any -->
{% endblock %}

{% block content %}
<div class="container py-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2><i class="fa fa-calendar-alt"></i> Schedule Management</h2>
    <!-- Replace your search bar container with this -->
    <div class="w-100" style="max-width:400px;position:relative;">
      <i class="fa fa-search" style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#aaa;font-size:1.1em;pointer-events:none;"></i>
      <input type="text" class="form-control" placeholder="Search user..." id="user-search" autocomplete="off" style="padding-left:2.5rem;">
      <span id="clear-user-search" style="position:absolute;right:18px;top:50%;transform:translateY(-50%);cursor:pointer;display:none;color:#aaa;font-size:1.2em;">&times;</span>
    </div>
  </div>

  <!-- Department bar placed under Schedule Management -->
  <div class="mb-3 d-flex align-items-center">
    <label for="department-select" class="mr-2 mb-0 font-weight-bold">Department:</label>
    <form method="get" action="{{ url_for('schedule.configure_schedule') }}" class="form-inline">
      <select id="department-select" name="department" class="form-control mr-2" onchange="this.form.submit()">
        <option value="" {% if not selected_department %}selected{% endif %} disabled>Select Department</option>
        {% for dept in departments %}
          <option value="{{ dept }}" {% if dept == selected_department %}selected{% endif %}>{{ dept }}</option>
        {% endfor %}
      </select>
      <input type="hidden" name="week_offset" value="{{ week_offset }}">
      <noscript><button type="submit" class="btn btn-primary btn-sm">Go</button></noscript>
    </form>
  </div>

  <!-- Navigation for week offset -->
  <div class="d-flex justify-content-between align-items-center mb-2">
    <form method="get" action="{{ url_for('schedule.configure_schedule') }}" class="mb-0">
      <input type="hidden" name="department" value="{{ selected_department }}">
      <input type="hidden" name="week_offset" value="{{ week_offset|int - 1 }}">
      <button type="submit" class="btn btn-outline-secondary btn-sm">
        <i class="fa fa-chevron-left"></i> Previous
      </button>
    </form>
    <span class="font-weight-bold">{{ week_range }}</span>
    <form method="get" action="{{ url_for('schedule.configure_schedule') }}" class="mb-0">
      <input type="hidden" name="department" value="{{ selected_department }}">
      <input type="hidden" name="week_offset" value="{{ week_offset|int + 1 }}">
      <button type="submit" class="btn btn-outline-secondary btn-sm">
        Next <i class="fa fa-chevron-right"></i>
      </button>
    </form>
  </div>

  <!-- Mobile day selector: only visible on mobile -->
  <div class="d-block d-md-none mb-2">
    <form method="get" action="{{ url_for('schedule.configure_schedule') }}" class="form-inline">
      <input type="hidden" name="department" value="{{ selected_department }}">
      <input type="hidden" name="week_offset" value="{{ week_offset }}">
      <label for="mobile-date-select" class="sr-only">Select Day</label>
      <select id="mobile-date-select" name="mobile_date" class="form-control w-100" onchange="this.form.submit()">
        {% for day, date in week_day_date %}
          <option value="{{ date }}" {% if date == mobile_date or (not mobile_date and date == now.strftime('%Y-%m-%d')) %}selected{% endif %}>
            {{ day }} ({{ date }})
          </option>
        {% endfor %}
      </select>
    </form>
  </div>

  <!-- Mobile info message: only visible on mobile -->
  <div class="alert alert-warning text-center d-block d-md-none mb-2" style="font-size:1em;">
    <i class="fa fa-info-circle mr-1"></i>
    It is recommended to use Schedule Management on desktop for the best experience.<br>
    On mobile, you can view and edit one day at a time. Use the dropdown above to switch days.
  </div>

  <div class="mb-2">
    <span class="badge badge-success">Day</span>
    <span class="badge badge-info">Evening</span>
    <span class="badge badge-warning">Leave</span>
    <span class="badge badge-secondary">— (No Shift)</span>
    <span class="ml-3 text-muted">Click <i class="fa fa-edit"></i> to edit, <i class="fa fa-copy"></i> to copy, <i class="fa fa-trash"></i> to delete.</span>
  </div>

  <!-- Add above your table, after badges row -->
  <div class="mb-3 d-flex justify-content-end">
    <button class="btn btn-outline-info" id="show-week-summary">
      <i class="fa fa-chart-bar mr-1"></i> Week Summary
    </button>
  </div>

  {% if not selected_department %}
    <div class="alert alert-info text-center my-4" role="alert">
      <i class="fa fa-info-circle mr-1"></i>
      Please select a department to view and manage the schedule.
    </div>
  {% else %}
    <div class="table-responsive">
      <table class="table table-bordered table-hover table-sm">
        <thead class="thead-light">
          <tr>
            <th class="sticky-top bg-white" style="min-width: 180px;">User</th>
            {% if mobile_date %}
              {% for day, date in week_day_date %}
                {% if date == mobile_date %}
                  <th class="sticky-top text-center {% if date == now.strftime('%Y-%m-%d') %}bg-warning{% endif %}">
                    <div>{{ day }}</div>
                    <div class="small text-muted">{{ date }}</div>
                  </th>
                {% endif %}
              {% endfor %}
            {% else %}
              {% for day, date in week_day_date %}
                <th class="sticky-top text-center {% if date == now.strftime('%Y-%m-%d') %}bg-warning{% endif %}">
                  <div>{{ day }}</div>
                  <div class="small text-muted">{{ date }}</div>
                </th>
              {% endfor %}
            {% endif %}
          </tr>
        </thead>
        <tbody id="schedule-table-body">
          {% for user in users %}
            {% set delay = loop.index0 * 0.04 %}
            <tr class="schedule-fade" style="--fade-delay: {{ delay }}s;">
              <td>
                <div class="d-flex align-items-center">
                  <img src="{{ user.avatar_url or url_for('static', filename='default_avatar.png') }}" class="rounded-circle mr-2" width="36" height="36">
                  <div>
                    <div><b>{{ user.name }}</b></div>
                    <div class="small text-muted">{{ user.role|capitalize }}</div>
                  </div>
                </div>
              </td>
              {% if mobile_date %}
                {% for date in week_dates %}
                  {% if date == mobile_date %}
                    {% set emp_id = user.employee_id|string %}
                    {% set shift_type = schedule_map.get(emp_id ~ '|' ~ date, '') %}
                    <td class="text-center align-middle"
                        data-employee="{{ user.employee_id }}"
                        data-date="{{ date }}"
                        {% if date == now.strftime('%Y-%m-%d') %}style="background-color: #fffbe6;"{% endif %}>
                      <div class="mb-1">
                        {% set emp_id = user.employee_id|string %}
                        {% set shift_type = schedule_map.get(emp_id ~ '|' ~ date, '') %}
                        <span class="badge
                          {% if shift_type == 'Day' %}badge-success
                          {% elif shift_type == 'Evening' %}badge-info
                          {% elif shift_type == 'Leave' %}badge-warning
                          {% else %}badge-secondary{% endif %}">
                          {% if shift_type == 'Day' %}
                            <i class="fa fa-sun"></i>
                          {% elif shift_type == 'Evening' %}
                            <i class="fa fa-moon"></i>
                          {% elif shift_type == 'Leave' %}
                            <i class="fa fa-plane"></i>
                          {% else %}
                            <i class="fa fa-minus"></i>
                          {% endif %}
                          {{ shift_type == 'Leave' and schedule_map.get(emp_id ~ '|' ~ date ~ '|leave_type', 'Leave') or shift_type or "—" }}
                        </span>
                        {% set st = schedule_map.get(user.employee_id ~ '|' ~ date ~ '|start_time', '') %}
                        {% set et = schedule_map.get(user.employee_id ~ '|' ~ date ~ '|end_time', '') %}
                        {% if st and et %}
                          <div>
                            <span class="badge badge-light border px-2 py-1 text-muted" style="font-size:0.85em;">
                              {{ st }} - {{ et }}
                            </span>
                          </div>
                        {% endif %}
                      </div>
                      {% set desc = schedule_map.get(user.employee_id ~ '|' ~ date ~ '|description', '') %}
                      {% set loc = schedule_map.get(user.employee_id ~ '|' ~ date ~ '|location', '') %}
                      {% if desc or loc %}
                        <span data-toggle="tooltip" title="Desc: {{ desc }}&#10;Loc: {{ loc }}">
                          <i class="fa fa-info-circle text-primary"></i>
                        </span>
                      {% endif %}
                      <div class="small text-muted mt-1" style="font-size: 0.75em;">
                        <span title="Last edited by">{{ schedule_map.get(user.employee_id ~ '|' ~ date ~ '|created_by', 'N/A') }}</span>
                        {% if updated %}
                          <span class="mx-1">|</span>
                          <span title="Last updated">{{ schedule_map.get(user.employee_id ~ '|' ~ date ~ '|last_updated', '') }}</span>
                        {% endif %}
                      </div>
                      <div class="mt-1">
                        <button type="button"
                                class="btn btn-sm btn-outline-primary edit-schedule-btn"
                                data-employee="{{ user.employee_id }}"
                                data-date="{{ date }}"
                                data-shift="{{ shift_type }}"
                                data-start="{{ schedule_map.get(user.employee_id ~ '|' ~ date ~ '|start_time', '') }}"
                                data-end="{{ schedule_map.get(user.employee_id ~ '|' ~ date ~ '|end_time', '') }}"
                                data-description="{{ schedule_map.get(user.employee_id ~ '|' ~ date ~ '|description', '') }}"
                                data-location="{{ schedule_map.get(user.employee_id ~ '|' ~ date ~ '|location', '') }}"
                                data-by="{{ schedule_map.get(user.employee_id ~ '|' ~ date ~ '|created_by', '') }}"
                                data-updated="{{ schedule_map.get(user.employee_id ~ '|' ~ date ~ '|last_updated', '') }}"
                                title="Edit">
                          <i class="fa fa-edit"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary copy-schedule-btn"
                                data-employee="{{ user.employee_id }}"
                                data-date="{{ date }}"
                                data-shift="{{ shift_type }}"
                                data-start="{{ schedule_map.get(user.employee_id ~ '|' ~ date ~ '|start_time', '') }}"
                                data-end="{{ schedule_map.get(user.employee_id ~ '|' ~ date ~ '|end_time', '') }}"
                                data-description="{{ schedule_map.get(user.employee_id ~ '|' ~ date ~ '|description', '') }}"
                                data-location="{{ schedule_map.get(user.employee_id ~ '|' ~ date ~ '|location', '') }}"
                                title="Copy">
                          <i class="fa fa-copy"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger delete-schedule-btn" data-employee="{{ user.employee_id }}" data-date="{{ date }}" title="Delete"><i class="fa fa-trash"></i></button>
                      </div>
                    </td>
                  {% endif %}
                {% endfor %}
              {% else %}
                {% for date in week_dates %}
                  {% set emp_id = user.employee_id|string %}
                  {% set shift_type = schedule_map.get(emp_id ~ '|' ~ date, '') %}
                  <td class="text-center align-middle"
                      data-employee="{{ user.employee_id }}"
                      data-date="{{ date }}"
                      {% if date == now.strftime('%Y-%m-%d') %}style="background-color: #fffbe6;"{% endif %}>
                    <div class="mb-1">
                      <span class="badge
                        {% if shift_type == 'Day' %}badge-success
                        {% elif shift_type == 'Evening' %}badge-info
                        {% elif shift_type == 'Leave' %}badge-warning
                        {% else %}badge-secondary{% endif %}">
                        {% if shift_type == 'Day' %}
                          <i class="fa fa-sun"></i>
                        {% elif shift_type == 'Evening' %}
                          <i class="fa fa-moon"></i>
                        {% elif shift_type == 'Leave' %}
                          <i class="fa fa-plane"></i>
                        {% else %}
                          <i class="fa fa-minus"></i>
                        {% endif %}
                        {{ shift_type == 'Leave' and schedule_map.get(user.employee_id ~ '|' ~ date ~ '|leave_type', 'Leave') or shift_type or "—" }}
                      </span>
                      {% set st = schedule_map.get(user.employee_id ~ '|' ~ date ~ '|start_time', '') %}
                      {% set et = schedule_map.get(user.employee_id ~ '|' ~ date ~ '|end_time', '') %}
                      {% if st and et %}
                        <div>
                          <span class="badge badge-light border px-2 py-1 text-muted" style="font-size:0.85em;">
                            {{ st }} - {{ et }}
                          </span>
                        </div>
                      {% endif %}
                    </div>
                    {% set desc = schedule_map.get(user.employee_id ~ '|' ~ date ~ '|description', '') %}
                    {% set loc = schedule_map.get(user.employee_id ~ '|' ~ date ~ '|location', '') %}
                    {% if desc or loc %}
                      <span data-toggle="tooltip" title="Desc: {{ desc }}&#10;Loc: {{ loc }}">
                        <i class="fa fa-info-circle text-primary"></i>
                      </span>
                    {% endif %}
                    <div class="small text-muted mt-1" style="font-size: 0.75em;">
                      <span title="Last edited by">{{ schedule_map.get(user.employee_id ~ '|' ~ date ~ '|created_by', 'N/A') }}</span>
                      {% if updated %}
                        <span class="mx-1">|</span>
                        <span title="Last updated">{{ schedule_map.get(user.employee_id ~ '|' ~ date ~ '|last_updated', '') }}</span>
                      {% endif %}
                    </div>
                    <div class="mt-1">
                      <button type="button"
                              class="btn btn-sm btn-outline-primary edit-schedule-btn"
                              data-employee="{{ user.employee_id }}"
                              data-date="{{ date }}"
                              data-shift="{{ shift_type }}"
                              data-start="{{ schedule_map.get(user.employee_id ~ '|' ~ date ~ '|start_time', '') }}"
                              data-end="{{ schedule_map.get(user.employee_id ~ '|' ~ date ~ '|end_time', '') }}"
                              data-description="{{ schedule_map.get(user.employee_id ~ '|' ~ date ~ '|description', '') }}"
                              data-location="{{ schedule_map.get(user.employee_id ~ '|' ~ date ~ '|location', '') }}"
                              data-by="{{ schedule_map.get(user.employee_id ~ '|' ~ date ~ '|created_by', '') }}"
                              data-updated="{{ schedule_map.get(user.employee_id ~ '|' ~ date ~ '|last_updated', '') }}"
                              title="Edit">
                        <i class="fa fa-edit"></i>
                      </button>
                      <button type="button" class="btn btn-sm btn-outline-secondary copy-schedule-btn"
                              data-employee="{{ user.employee_id }}"
                              data-date="{{ date }}"
                              data-shift="{{ shift_type }}"
                              data-start="{{ schedule_map.get(user.employee_id ~ '|' ~ date ~ '|start_time', '') }}"
                              data-end="{{ schedule_map.get(user.employee_id ~ '|' ~ date ~ '|end_time', '') }}"
                              data-description="{{ schedule_map.get(user.employee_id ~ '|' ~ date ~ '|description', '') }}"
                              data-location="{{ schedule_map.get(user.employee_id ~ '|' ~ date ~ '|location', '') }}"
                              title="Copy">
                        <i class="fa fa-copy"></i>
                      </button>
                      <button type="button" class="btn btn-sm btn-outline-danger delete-schedule-btn" data-employee="{{ user.employee_id }}" data-date="{{ date }}" title="Delete"><i class="fa fa-trash"></i></button>
                    </div>
                  </td>
                {% endfor %}
              {% endif %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% endif %}
</div>

<div class="modal fade" id="editScheduleModal" tabindex="-1" role="dialog" aria-labelledby="editScheduleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <form id="edit-schedule-form" method="post" action="{{ url_for('schedule.edit_schedule') }}">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editScheduleModalLabel">Edit Schedule</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div id="modal-last-edited" class="alert alert-info py-2 px-3 mb-2" style="display:none;"></div>
          <input type="hidden" name="employee_id" id="modal-employee-id">
          <input type="hidden" name="date" id="modal-date">
          <input type="hidden" name="department" id="modal-department" value="{{ selected_department }}">
          <input type="hidden" name="week_offset" id="modal-week-offset" value="{{ week_offset }}">
          <div class="form-group">
            <label for="modal-shift-type">Shift Type <span class="text-danger">*</span></label>
            <select class="form-control" name="shift_type" id="modal-shift-type" required>
              <option value="" disabled selected>— Select Shift Type —</option>
              <option value="Day">Day</option>
              <option value="Evening">Evening</option>
              <option value="Leave">Leave</option>
            </select>
          </div>
          <div class="form-group">
            <label for="modal-start-time">Start Time <span class="text-danger">*</span></label>
            <input type="time" class="form-control" name="start_time" id="modal-start-time" required>
          </div>
          <div class="form-group">
            <label for="modal-end-time">End Time <span class="text-danger">*</span></label>
            <input type="time" class="form-control" name="end_time" id="modal-end-time" required>
          </div>
          <div class="form-group">
            <label for="modal-description">Description</label>
            <input type="text" class="form-control" name="description" id="modal-description">
          </div>
          <div class="form-group">
            <label for="modal-location">Location <span class="text-danger">*</span></label>
            <select class="form-control" name="location" id="modal-location" required>
              <option value="" disabled selected>— Select Location —</option>
              <option value="Store No. 4327">Store No. 4327</option>
              <option value="Store No. 4325">Store No. 4325</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save changes</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Add this modal just before your closing </body> or before your script block -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" role="dialog" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteConfirmModalLabel">Delete Shift</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete this shift?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" id="confirm-delete-btn" class="btn btn-danger">Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- Modern Week Summary Modal -->
<div class="modal fade" id="weekSummaryModal" tabindex="-1" aria-labelledby="weekSummaryModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="weekSummaryModalLabel">
          <i class="fa fa-chart-bar mr-2"></i>Week Summary
        </h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info py-2 mb-3" style="font-size:0.97em;">
          <i class="fa fa-info-circle mr-1"></i>
          To see another week's summary, use the <b>Previous</b> or <b>Next</b> buttons above the table, then open this summary again.
        </div>
        <div class="mb-3">
          <label for="summary-day-select" class="fw-semibold me-2">Select Day:</label>
          <select id="summary-day-select" class="form-select d-inline-block w-auto">
            {% for day, date in week_day_date %}
              <option value="{{ date }}">{{ day }} ({{ date }})</option>
            {% endfor %}
          </select>
        </div>
        <div id="week-summary-content"></div>
      </div>
    </div>
  </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="exportPreviewModal" tabindex="-1" role="dialog" aria-labelledby="exportPreviewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="exportPreviewModalLabel">
          <i class="fa fa-eye mr-2"></i>Export Preview
        </h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" id="export-preview-body" style="max-height:60vh;overflow:auto;"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirm-export-btn">Export</button>
      </div>
    </div>
  </div>
</div>

<div id="loading-overlay" style="display:none;position:fixed;z-index:2000;top:0;left:0;width:100vw;height:100vh;background:rgba(255,255,255,0.7);align-items:center;justify-content:center;">
  <div class="spinner-border text-primary" style="width:3rem;height:3rem;" role="status">
    <span class="sr-only">Loading...</span>
  </div>
</div>

<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
$(function () {
  // Enable tooltips
  $('[data-toggle="tooltip"]').tooltip();

  // Use event delegation for dynamically rendered buttons
  $(document).on('click', '.edit-schedule-btn', function () {
    $('#modal-employee-id').val($(this).data('employee'));
    $('#modal-date').val($(this).data('date'));
    $('#modal-shift-type').val($(this).data('shift'));
    $('#modal-start-time').val($(this).data('start'));
    $('#modal-end-time').val($(this).data('end'));
    $('#modal-description').val($(this).data('description'));
    $('#modal-location').val($(this).data('location'));

    // Set department and week_offset
    $('#modal-department').val("{{ selected_department }}");
    $('#modal-week-offset').val("{{ week_offset }}");

    // Show last edited info
    var by = $(this).data('by') || 'N/A';
    var updated = $(this).data('updated') || '';
    var info = '<b>Last edited by:</b> ' + by;
    if (updated) info += '<br><b>On:</b> ' + updated;
    $('#modal-last-edited').html(info).show();

    console.log('Opening modal with:', copiedShift, $(this).data('employee'), $(this).data('date'));
    $('#editScheduleModal').modal('show');
  });

  // Store copied shift data globally
  let copiedShift = null;

  // Copy shift when clicking the copy button
  $(document).on('click', '.copy-schedule-btn', function () {
    copiedShift = {
      shift_type: $(this).data('shift'),
      start_time: $(this).data('start'),
      end_time: $(this).data('end'),
      description: $(this).data('description'),
      location: $(this).data('location')
    };
    showCopyToast('Shift copied! Double-click another cell to paste.');
    console.log('Copied shift:', copiedShift);
  });

  // Paste shift on double-clicking a cell (excluding header/user column)
  $(document).on('dblclick', 'td.text-center.align-middle, td.text-center.align-middle *', function (e) {
    console.log('Double-click event fired!');
    let $cell = $(this).closest('td.text-center.align-middle');
    $('#copy-toast').fadeOut(200);
    if (!copiedShift) {
      showCopyToast('No shift copied. Please copy a shift first.');
      return;
    }
    console.log('Opening modal with:', copiedShift, $cell.data('employee'), $cell.data('date'));
    $('#modal-employee-id').val($cell.data('employee'));
    $('#modal-date').val($cell.data('date'));
    $('#modal-shift-type').val(copiedShift.shift_type || "");
    $('#modal-start-time').val(copiedShift.start_time || "");
    $('#modal-end-time').val(copiedShift.end_time || "");
    $('#modal-description').val(copiedShift.description || "");
    $('#modal-location').val(copiedShift.location || "");
    $('#modal-department').val("{{ selected_department }}");
    $('#modal-week-offset').val("{{ week_offset }}");
    $('#modal-last-edited').hide().html('');
    $('#editScheduleModal').modal('show');
  });

  // Store delete info temporarily
  let deleteData = {};

  $(document).on('click', '.delete-schedule-btn', function () {
    deleteData = {
      employee_id: $(this).data('employee'),
      date: $(this).data('date'),
      department: "{{ selected_department }}",
      week_offset: "{{ week_offset }}"
    };
    $('#deleteConfirmModal').modal('show');
  });

  $('#confirm-delete-btn').on('click', function () {
    var form = $('<form>', {
      method: 'POST',
      action: "{{ url_for('schedule.delete_schedule') }}"
    });
    form.append($('<input>', {type: 'hidden', name: 'employee_id', value: deleteData.employee_id}));
    form.append($('<input>', {type: 'hidden', name: 'date', value: deleteData.date}));
    form.append($('<input>', {type: 'hidden', name: 'department', value: deleteData.department}));
    form.append($('<input>', {type: 'hidden', name: 'week_offset', value: deleteData.week_offset}));
    form.appendTo('body').submit();
    $('#deleteConfirmModal').modal('hide');
  });

  // Optional: Clear modal on close
  $('#editScheduleModal').on('hidden.bs.modal', function () {
    $('#edit-schedule-form')[0].reset();
    $('#modal-last-edited').hide().html('');
  });

  // Helper: show a toast message
  function showCopyToast(msg) {
    let $toast = $('#copy-toast');
    if (!$toast.length) {
      $toast = $('<div id="copy-toast"></div>').css({
        position: 'fixed',
        top: '80px',
        left: '50%',
        transform: 'translateX(-50%)',
        background: 'linear-gradient(90deg, #6f42c1 0%, #8f6ee0 100%)',
        color: '#fff',
        padding: '12px 32px',
        borderRadius: '8px',
        zIndex: 2000,
        fontWeight: 600,
        fontSize: '1.08em',
        boxShadow: '0 4px 24px rgba(0,0,0,0.13)',
        letterSpacing: '0.5px'
      }).appendTo('body');
    }
    $toast.text(msg).fadeIn(200);
    setTimeout(() => $toast.fadeOut(400), 3000);
  }

  // User search functionality
  $('#user-search').on('input', function() {
    $('#clear-user-search').toggle(!!this.value);
    var val = $(this).val().toLowerCase();
    $('#schedule-table-body tr').each(function() {
      var user = $(this).find('td:first').text().toLowerCase();
      $(this).toggle(user.indexOf(val) !== -1);
    });
  });
  $('#clear-user-search').on('click', function() {
    $('#user-search').val('').trigger('input');
  });

  // Show loading spinner on any form submit
  $('form').on('submit', function() {
    $('#loading-overlay').fadeIn(150);
  });

  // Hide spinner after page load (in case of fast navigation)
  $(window).on('pageshow load', function() {
    $('#loading-overlay').fadeOut(150);
  });

  // Validate and handle edit schedule form submission
  $('#edit-schedule-form').on('submit', function(e) {
    var shiftType = $('#modal-shift-type').val();
    var location = $('#modal-location').val();
    if (!shiftType) {
      alert('Please select a valid Shift Type.');
      $('#modal-shift-type').focus();
      e.preventDefault();
      return false;
    }
    if (!location) {
      alert('Please select a valid Location.');
      $('#modal-location').focus();
      e.preventDefault();
      return false;
    }
  });

  // Show Week Summary Modal
  $('#show-week-summary').on('click', function () {
    $('#weekSummaryModal').modal('show');
    $('#summary-day-select').trigger('change');
  });

  // Populate summary when day is changed
  $('#summary-day-select').on('change', function () {
    var selectedDate = $(this).val();
    var summaryRows = '';
    var scheduledCount = 0;
    $('#schedule-table-body tr').each(function () {
      var $row = $(this);
      var userName = $row.find('td:first b').text();
      var userRole = $row.find('td:first .small').text();
      var $cell = $row.find('td[data-date="' + selectedDate + '"]');
      if ($cell.length) {
        var shift = $cell.find('.badge').text().trim();
        var time = $cell.find('.badge-light, .badge.bg-light').text().trim();
        if (shift && shift !== '—') {
          scheduledCount++;
          summaryRows += `
            <tr>
              <td>${userName} <span class="text-muted small">(${userRole})</span></td>
              <td>${shift}</td>
              <td>${time || ''}</td>
            </tr>
          `;
        }
      }
    });
    var html = `
      <div class="mb-2">
        <b>Total scheduled:</b> ${scheduledCount}
        <button class="btn btn-sm btn-outline-secondary float-right ml-2" id="export-summary-pdf">
          <i class="fa fa-file-pdf-o"></i> Export PDF
        </button>
        <button class="btn btn-sm btn-outline-secondary float-right" id="export-summary-btn">
          <i class="fa fa-download"></i> Export CSV
        </button>
      </div>
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>User</th>
            <th>Shift</th>
            <th>Time</th>
          </tr>
        </thead>
        <tbody>
          ${summaryRows || '<tr><td colspan="3" class="text-center text-muted">No scheduled people for this day.</td></tr>'}
        </tbody>
      </table>
    `;
    $('#week-summary-content').html(html);
  });

  // Auto-fill start/end time when shift type changes in modal
  $('#modal-shift-type').on('change', function() {
    if (this.value === 'Day') {
      $('#modal-start-time').val('08:00');
      $('#modal-end-time').val('16:00');
    } else if (this.value === 'Evening') {
      $('#modal-start-time').val('16:00');
      $('#modal-end-time').val('23:59');
    } else {
      $('#modal-start-time').val('');
      $('#modal-end-time').val('');
    }
  });

  let exportType = null;
  let exportData = null;

  $(document).on('click', '#export-summary-btn', function () {
    // Prepare CSV preview
    var rows = [];
    $('#week-summary-content table thead tr').each(function () {
      var cols = [];
      $(this).find('th').each(function () {
        cols.push($(this).text());
      });
      if (cols.length) rows.push(cols.join(','));
    });
    $('#week-summary-content table tbody tr').each(function () {
      var cols = [];
      $(this).find('td').each(function () {
        cols.push($(this).text());
      });
      if (cols.length) rows.push(cols.join(','));
    });
    var csv = rows.join('\n');
    exportType = 'csv';
    exportData = csv;
    $('#export-preview-body').html(
      `<pre style="white-space:pre-wrap;word-break:break-all;">${csv.replace(/</g, '&lt;')}</pre>`
    );
    $('#exportPreviewModal').modal('show');
  });

  $(document).on('click', '#export-summary-pdf', function () {
    // Prepare PDF preview (render table as image)
    var summaryTable = $('#week-summary-content table')[0];
    html2canvas(summaryTable).then(function(canvas) {
      exportType = 'pdf';
      exportData = canvas;
      $('#export-preview-body').html(
        `<div class="text-center"><img src="${canvas.toDataURL('image/png')}" class="img-fluid" style="max-height:400px;"/></div>`
      );
      $('#exportPreviewModal').modal('show');
    });
  });

  // Confirm export after preview
  $(document).on('click', '#confirm-export-btn', function () {
    if (exportType === 'csv') {
      var blob = new Blob([exportData], { type: 'text/csv' });
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = 'week_summary.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    } else if (exportType === 'pdf') {
      var canvas = exportData;
      var imgData = canvas.toDataURL('image/png');
      var pdf = new window.jspdf.jsPDF('p', 'pt', 'a4');
      var pageWidth = pdf.internal.pageSize.getWidth();
      var margin = 40;
      var y = margin;

      // Get details from the summary modal, not the main page
      var weekRange = '';
      // Try to get week range from the modal if present, fallback to main page
      var $modalWeek = $('#weekSummaryModal .modal-title').closest('.modal').find('.font-weight-bold');
      if ($modalWeek.length) {
        weekRange = $modalWeek.first().text().trim();
      }
      if (!weekRange) {
        weekRange = $('.font-weight-bold').first().text().trim();
      }

      // Department: get from the selected option in the department dropdown
      var department = $('#department-select option:selected').text().trim();

      // Day: get from the summary modal's select
      var dayText = $('#summary-day-select option:selected').text().trim();

      // Add details
      pdf.setFontSize(22);
      pdf.setTextColor(33, 76, 193); // Example: blue color
      pdf.text("GlobalTech Inc.", margin, y);
      y += 30;
      pdf.setTextColor(0, 0, 0); // Reset to black
      pdf.setFontSize(18);
      pdf.text("Week Summary", margin, y);
      y += 28;
      pdf.setFontSize(12);
      pdf.text("Department: " + department, margin, y);
      y += 18;
      pdf.text("Week: " + weekRange, margin, y);
      y += 18;
      pdf.text("Day: " + dayText, margin, y);
      y += 18;

      // Add table image
      var imgWidth = pageWidth - margin * 2;
      var imgHeight = canvas.height * imgWidth / canvas.width;
      pdf.addImage(imgData, 'PNG', margin, y, imgWidth, imgHeight);

      // Open PDF in new tab for preview
      window.open(pdf.output('bloburl'), '_blank');
    }
    $('#exportPreviewModal').modal('hide');
  });

  console.log('copiedShift:', copiedShift);
  console.log('Script loaded!');
});
</script>

<style>
@keyframes fadeInUp {}
@keyframes fadeInDown {}
</style>
{% endblock %}